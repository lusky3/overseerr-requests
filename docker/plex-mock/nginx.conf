events {}
http {
    default_type application/json;
    
    # Map to handle X-Plex-Token from query params or headers
    map $arg_X_Plex_Token $plex_token {
        default $arg_X_Plex_Token;
        '' $http_x_plex_token;
    }
    
    server {
        listen 32400;
        
        # Add common Plex headers to all responses
        add_header X-Plex-Protocol 1.0 always;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "X-Plex-Token, X-Plex-Client-Identifier, X-Plex-Product, X-Plex-Version, X-Plex-Target-Client-Identifier, Accept, Content-Type" always;
        
        # Handle OPTIONS requests for CORS
        if ($request_method = OPTIONS) {
            return 204;
        }
        
        # ============================================
        # CORE SERVER ENDPOINTS
        # ============================================
        
        # Server root - status and capabilities
        location = / {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":0,"allowCameraUpload":false,"allowChannelAccess":true,"allowMediaDeletion":true,"allowSharing":true,"allowSync":false,"backgroundProcessing":true,"certificate":true,"companionProxy":true,"diagnostics":true,"eventStream":true,"friendlyName":"Mock Plex Server","hubSearch":true,"machineIdentifier":"mock-plex-server-12345","multiuser":true,"myPlex":true,"myPlexMappingState":"mapped","myPlexSigninState":"ok","myPlexSubscription":true,"myPlexUsername":"mockuser","offlineTranscode":true,"ownerFeatures":"hardware_transcoding,home,pass,sync,webhooks","photoAutoTag":true,"platform":"Linux","platformVersion":"5.10.0","pluginHost":true,"pushNotifications":true,"readOnlyLibraries":false,"requestParametersInCookie":true,"streamingBrainVersion":"2","sync":true,"transcoderActiveVideoSessions":0,"transcoderAudio":true,"transcoderLyrics":true,"transcoderPhoto":true,"transcoderSubtitles":true,"transcoderVideo":true,"transcoderVideoBitrates":"64,96,208,320,720,1500,2000,3000,4000,8000,10000,12000,20000","transcoderVideoQualities":"0,1,2,3,4,5,6,7,8,9,10,11,12","transcoderVideoResolutions":"128,128,160,240,320,480,768,720,720,1080,1080,1080,1080","updatedAt":1234567890,"updater":true,"version":"1.32.0.6865-1234567890","voiceSearch":true}}';
        }
        
        # Server identity
        location = /identity {
            add_header Content-Type application/json;
            return 200 '{"size":1,"claimed":true,"machineIdentifier":"mock-plex-server-12345","version":"1.32.0.6865-1234567890"}';
        }
        
        # Server list
        location = /servers {
            add_header Content-Type application/xml;
            return 200 '<?xml version="1.0" encoding="UTF-8"?>
<MediaContainer size="1">
  <Server name="Mock Plex Server" host="plex-mock" address="plex-mock" port="32400" machineIdentifier="mock-plex-server-12345" version="1.32.0.6865-1234567890" scheme="http" owned="1" synced="0"/>
</MediaContainer>';
        }
        
        # Server preferences
        location = /:/prefs {
            add_header Content-Type application/xml;
            return 200 '<?xml version="1.0" encoding="UTF-8"?>
<MediaContainer size="1">
  <Setting id="FriendlyName" label="Friendly name" summary="This name will be used to identify this media server to other computers on your network." type="text" default="Mock Plex Server" value="Mock Plex Server" hidden="0" advanced="0" group="general"/>
</MediaContainer>';
        }
        
        # ============================================
        # USER & ACCOUNT ENDPOINTS
        # ============================================
        
        # User account info
        location = /myplex/account {
            add_header Content-Type application/xml;
            return 200 '<?xml version="1.0" encoding="UTF-8"?>
<user email="mock@example.com" id="12345" uuid="mock-user-uuid" username="mockuser" title="Mock User" thumb="https://plex.tv/users/1234567890/avatar?c=1234567890" hasPassword="true" authToken="mock-auth-token" subscription="1" subscriptionActive="1" subscriptionStatus="Active" subscriptionPlan="lifetime" subscriptionFeatures="sync,mobile_sync,cloud_sync,pass,premium_music_metadata,hardware_transcoding" roles="admin" entitlements="all"/>';
        }
        
        # ============================================
        # LIBRARY ENDPOINTS
        # ============================================
        
        # List all library sections
        location = /library/sections {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":2,"allowSync":1,"title1":"Plex Library","Directory":[{"allowSync":1,"art":"/:/resources/movie-fanart.jpg","composite":"/library/sections/1/composite/1234567890","filters":1,"refreshing":0,"thumb":"/:/resources/movie.png","key":"1","type":"movie","title":"Movies","agent":"tv.plex.agents.movie","scanner":"Plex Movie","language":"en-US","uuid":"12345678-1234-1234-1234-123456789012","updatedAt":1234567890,"createdAt":1234567890,"scannedAt":1234567890,"Location":[{"id":1,"path":"/movies"}]},{"allowSync":1,"art":"/:/resources/show-fanart.jpg","composite":"/library/sections/2/composite/1234567890","filters":1,"refreshing":0,"thumb":"/:/resources/show.png","key":"2","type":"show","title":"TV Shows","agent":"tv.plex.agents.series","scanner":"Plex TV Series","language":"en-US","uuid":"87654321-4321-4321-4321-210987654321","updatedAt":1234567890,"createdAt":1234567890,"scannedAt":1234567890,"Location":[{"id":2,"path":"/tv"}]}]}}';
        }
        
        # Get library section contents
        location ~ ^/library/sections/([0-9]+)/all$ {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":3,"totalSize":3,"offset":0,"Metadata":[{"ratingKey":"1001","key":"/library/metadata/1001","guid":"plex://movie/5d776b59ad5437001f79c6f8","type":"movie","title":"The Matrix","originalTitle":"The Matrix","contentRating":"R","rating":8.7,"audienceRating":8.5,"year":1999,"tagline":"Welcome to the Real World","summary":"A computer hacker learns from mysterious rebels about the true nature of his reality and his role in the war against its controllers.","duration":8160000,"originallyAvailableAt":"1999-03-31","addedAt":1234567890,"updatedAt":1234567890,"thumb":"/library/metadata/1001/thumb/1234567890","art":"/library/metadata/1001/art/1234567890","Guid":[{"id":"imdb://tt0133093"},{"id":"tmdb://603"},{"id":"tvdb://movie/603"}],"Genre":[{"tag":"Action"},{"tag":"Sci-Fi"}],"Director":[{"tag":"Lana Wachowski"},{"tag":"Lilly Wachowski"}],"Writer":[{"tag":"Lana Wachowski"},{"tag":"Lilly Wachowski"}],"Country":[{"tag":"USA"}],"Role":[{"tag":"Keanu Reeves"},{"tag":"Laurence Fishburne"},{"tag":"Carrie-Anne Moss"}],"Media":[{"id":2001,"duration":8160000,"bitrate":10000,"width":1920,"height":1080,"aspectRatio":1.78,"audioChannels":6,"audioCodec":"ac3","videoCodec":"h264","videoResolution":"1080","container":"mkv","videoFrameRate":"24p","Part":[{"id":3001,"key":"/library/parts/3001/1234567890/file.mkv","duration":8160000,"file":"/movies/The.Matrix.1999.1080p.mkv","size":7500000000,"container":"mkv","videoProfile":"high"}]}]},{"ratingKey":"1002","key":"/library/metadata/1002","guid":"plex://movie/5d776825880197001ec9007e","type":"movie","title":"Inception","contentRating":"PG-13","rating":8.8,"year":2010,"summary":"A thief who steals corporate secrets through the use of dream-sharing technology.","duration":8880000,"originallyAvailableAt":"2010-07-16","addedAt":1234567890,"updatedAt":1234567890,"thumb":"/library/metadata/1002/thumb/1234567890","art":"/library/metadata/1002/art/1234567890","Guid":[{"id":"imdb://tt1375666"},{"id":"tmdb://27205"},{"id":"tvdb://movie/27205"}],"Media":[{"id":2002,"duration":8880000,"bitrate":10000,"width":1920,"height":1080,"aspectRatio":1.78,"audioChannels":6,"audioCodec":"ac3","videoCodec":"h264","videoResolution":"1080","container":"mkv","videoFrameRate":"24p","Part":[{"id":3002,"key":"/library/parts/3002/1234567890/file.mkv","duration":8880000,"file":"/movies/Inception.2010.1080p.mkv","size":8000000000,"container":"mkv","videoProfile":"high"}]}]},{"ratingKey":"1003","key":"/library/metadata/1003","guid":"plex://movie/5d7768269251a7001e8c5c8f","type":"movie","title":"Interstellar","contentRating":"PG-13","rating":8.6,"year":2014,"summary":"A team of explorers travel through a wormhole in space.","duration":10140000,"originallyAvailableAt":"2014-11-07","addedAt":1234567890,"updatedAt":1234567890,"thumb":"/library/metadata/1003/thumb/1234567890","art":"/library/metadata/1003/art/1234567890","Guid":[{"id":"imdb://tt0816692"},{"id":"tmdb://157336"},{"id":"tvdb://movie/157336"}],"Media":[{"id":2003,"duration":10140000,"bitrate":10000,"width":1920,"height":1080,"aspectRatio":1.78,"audioChannels":6,"audioCodec":"ac3","videoCodec":"h264","videoResolution":"1080","container":"mkv","videoFrameRate":"24p","Part":[{"id":3003,"key":"/library/parts/3003/1234567890/file.mkv","duration":10140000,"file":"/movies/Interstellar.2014.1080p.mkv","size":9000000000,"container":"mkv","videoProfile":"high"}]}]}]}}';
        }
        
        # Refresh library section
        location ~ ^/library/sections/([0-9]+)/refresh$ {
            return 200 '{"status":"ok","message":"Library refresh initiated"}';
        }
        
        # Refresh all libraries
        location = /library/sections/all/refresh {
            return 200 '{"status":"ok","message":"All libraries refresh initiated"}';
        }
        
        # Analyze library section
        location ~ ^/library/sections/([0-9]+)/analyze$ {
            return 200 '{"status":"ok","message":"Library analysis initiated"}';
        }
        
        # Empty trash for library section
        location ~ ^/library/sections/([0-9]+)/emptyTrash$ {
            return 200 '{"status":"ok","message":"Trash emptied"}';
        }
        
        # Get collections in library section
        location ~ ^/library/sections/([0-9]+)/collections$ {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"10001","key":"/library/collections/10001","type":"collection","title":"The Matrix Collection","summary":"","childCount":3,"leafCount":3,"addedAt":1234567890,"updatedAt":1234567890}]}}';
        }
        
        # Search within library section
        location ~ ^/library/sections/([0-9]+)/search$ {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"1001","type":"movie","title":"The Matrix","year":1999,"librarySectionID":1,"librarySectionTitle":"Movies"}]}}';
        }
        
        # ============================================
        # METADATA ENDPOINTS
        # ============================================
        
        # Get specific metadata item - The Matrix
        location = /library/metadata/1001 {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"1001","key":"/library/metadata/1001","guid":"plex://movie/5d776b59ad5437001f79c6f8","type":"movie","title":"The Matrix","year":1999,"summary":"A computer hacker learns from mysterious rebels about the true nature of his reality.","rating":8.7,"duration":8160000,"thumb":"/library/metadata/1001/thumb/1234567890","art":"/library/metadata/1001/art/1234567890","Guid":[{"id":"imdb://tt0133093"},{"id":"tmdb://603"},{"id":"tvdb://movie/603"}],"Media":[{"id":2001,"duration":8160000,"bitrate":10000,"width":1920,"height":1080,"aspectRatio":1.78,"audioChannels":6,"audioCodec":"ac3","videoCodec":"h264","videoResolution":"1080","container":"mkv","videoFrameRate":"24p","Part":[{"id":3001,"key":"/library/parts/3001/1234567890/file.mkv","duration":8160000,"file":"/movies/The.Matrix.1999.1080p.mkv","size":7500000000,"container":"mkv","videoProfile":"high"}]}]}]}}';
        }
        
        # Get specific metadata item - Inception
        location = /library/metadata/1002 {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"1002","key":"/library/metadata/1002","guid":"plex://movie/5d776825880197001ec9007e","type":"movie","title":"Inception","year":2010,"summary":"A thief who steals corporate secrets through the use of dream-sharing technology.","rating":8.8,"duration":8880000,"thumb":"/library/metadata/1002/thumb/1234567890","art":"/library/metadata/1002/art/1234567890","Guid":[{"id":"imdb://tt1375666"},{"id":"tmdb://27205"},{"id":"tvdb://movie/27205"}],"Media":[{"id":2002,"duration":8880000,"bitrate":10000,"width":1920,"height":1080,"aspectRatio":1.78,"audioChannels":6,"audioCodec":"ac3","videoCodec":"h264","videoResolution":"1080","container":"mkv","videoFrameRate":"24p","Part":[{"id":3002,"key":"/library/parts/3002/1234567890/file.mkv","duration":8880000,"file":"/movies/Inception.2010.1080p.mkv","size":8000000000,"container":"mkv","videoProfile":"high"}]}]}]}}';
        }
        
        # Get specific metadata item - Interstellar
        location = /library/metadata/1003 {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"1003","key":"/library/metadata/1003","guid":"plex://movie/5d7768269251a7001e8c5c8f","type":"movie","title":"Interstellar","year":2014,"summary":"A team of explorers travel through a wormhole in space.","rating":8.6,"duration":10140000,"thumb":"/library/metadata/1003/thumb/1234567890","art":"/library/metadata/1003/art/1234567890","Guid":[{"id":"imdb://tt0816692"},{"id":"tmdb://157336"},{"id":"tvdb://movie/157336"}],"Media":[{"id":2003,"duration":10140000,"bitrate":10000,"width":1920,"height":1080,"aspectRatio":1.78,"audioChannels":6,"audioCodec":"ac3","videoCodec":"h264","videoResolution":"1080","container":"mkv","videoFrameRate":"24p","Part":[{"id":3003,"key":"/library/parts/3003/1234567890/file.mkv","duration":10140000,"file":"/movies/Interstellar.2014.1080p.mkv","size":9000000000,"container":"mkv","videoProfile":"high"}]}]}]}}';
        }
        
        # Get specific metadata item - Generic fallback
        location ~ ^/library/metadata/([0-9]+)$ {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"$1","key":"/library/metadata/$1","guid":"plex://movie/unknown","type":"movie","title":"Unknown Movie","year":2020,"summary":"Unknown movie.","rating":7.0,"duration":7200000,"thumb":"/library/metadata/$1/thumb/1234567890","art":"/library/metadata/$1/art/1234567890","Guid":[{"id":"tmdb://0"}],"Media":[{"id":2000,"duration":7200000,"bitrate":10000,"width":1920,"height":1080,"aspectRatio":1.78,"audioChannels":6,"audioCodec":"ac3","videoCodec":"h264","videoResolution":"1080","container":"mkv","videoFrameRate":"24p","Part":[{"id":3000,"key":"/library/parts/3000/1234567890/file.mkv","duration":7200000,"file":"/movies/Unknown.mkv","size":6000000000,"container":"mkv","videoProfile":"high"}]}]}]}}';
        }
        
        # Update metadata
        location ~ ^/library/metadata/([0-9]+)$ {
            if ($request_method = PUT) {
                return 200 '{"status":"ok"}';
            }
        }
        
        # Get metadata thumbnail
        location ~ ^/library/metadata/([0-9]+)/thumb {
            add_header Content-Type image/jpeg;
            return 200 '';
        }
        
        # Get metadata art
        location ~ ^/library/metadata/([0-9]+)/art {
            add_header Content-Type image/jpeg;
            return 200 '';
        }
        
        # Upload poster
        location ~ ^/library/metadata/([0-9]+)/posters$ {
            if ($request_method = POST) {
                return 200 '{"status":"ok"}';
            }
        }
        
        # ============================================
        # SEARCH ENDPOINTS
        # ============================================
        
        # Global search
        location = /search {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":2,"Metadata":[{"ratingKey":"1001","type":"movie","title":"The Matrix","year":1999,"librarySectionID":1,"librarySectionTitle":"Movies"},{"ratingKey":"2001","type":"show","title":"The Matrix Animated Series","year":2003,"librarySectionID":2,"librarySectionTitle":"TV Shows"}]}}';
        }
        
        # ============================================
        # PLAYBACK & SESSION ENDPOINTS
        # ============================================
        
        # Active playback sessions
        location = /status/sessions {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":0,"Metadata":[]}}';
        }
        
        # Watch history
        location = /status/sessions/history/all {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":0,"Metadata":[]}}';
        }
        
        # Transcode sessions
        location = /transcode/sessions {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":0,"TranscodeSession":[]}}';
        }
        
        # Delete transcode session
        location ~ ^/transcode/sessions/(.+)$ {
            if ($request_method = DELETE) {
                return 200 '{"status":"ok"}';
            }
        }
        
        # ============================================
        # CLIENT ENDPOINTS
        # ============================================
        
        # List available clients
        location = /clients {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":1,"Server":[{"name":"Mock Client","host":"192.168.1.150","machineIdentifier":"mock-client-123","version":"8.30.0","protocol":"plex","product":"Plex for TV","deviceClass":"tv","protocolVersion":"1","protocolCapabilities":"timeline,playback,navigation"}]}}';
        }
        
        # ============================================
        # COLLECTION ENDPOINTS
        # ============================================
        
        # Create collection
        location = /library/collections {
            if ($request_method = POST) {
                add_header Content-Type application/json;
                return 201 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"10002","key":"/library/collections/10002","type":"collection","title":"New Collection","childCount":0,"addedAt":1234567890}]}}';
            }
        }
        
        # Add items to collection
        location ~ ^/library/collections/([0-9]+)/items$ {
            if ($request_method = PUT) {
                return 200 '{"status":"ok"}';
            }
        }
        
        # ============================================
        # PLAYLIST ENDPOINTS
        # ============================================
        
        # Get all playlists
        location = /playlists {
            if ($request_method = GET) {
                add_header Content-Type application/json;
                return 200 '{"MediaContainer":{"size":0,"Metadata":[]}}';
            }
            if ($request_method = POST) {
                add_header Content-Type application/json;
                return 201 '{"MediaContainer":{"size":1,"Metadata":[{"ratingKey":"99999","key":"/playlists/99999","type":"playlist","title":"New Playlist","playlistType":"video","smart":0,"leafCount":0,"addedAt":1234567890}]}}';
            }
        }
        
        # Manage playlist items
        location ~ ^/playlists/([0-9]+)/items$ {
            if ($request_method = PUT) {
                return 200 '{"status":"ok"}';
            }
            if ($request_method = DELETE) {
                return 200 '{"status":"ok"}';
            }
        }
        
        # Delete playlist
        location ~ ^/playlists/([0-9]+)$ {
            if ($request_method = DELETE) {
                return 200 '{"status":"ok"}';
            }
        }
        
        # ============================================
        # WATCHED STATUS ENDPOINTS
        # ============================================
        
        # Mark as watched (scrobble)
        location = /:/scrobble {
            return 200 '{"status":"ok"}';
        }
        
        # Mark as unwatched (unscrobble)
        location = /:/unscrobble {
            return 200 '{"status":"ok"}';
        }
        
        # ============================================
        # MEDIA STREAMING ENDPOINTS
        # ============================================
        
        # Media part download/stream
        location ~ ^/library/parts/([0-9]+)/([0-9]+)/file\.(mkv|mp4|avi)$ {
            add_header Content-Type video/mp4;
            return 200 '';
        }
        
        # Photo transcode
        location = /photo/:/transcode {
            add_header Content-Type image/jpeg;
            return 200 '';
        }
        
        # Video transcode start
        location = /video/:/transcode/universal/start.m3u8 {
            add_header Content-Type application/vnd.apple.mpegurl;
            return 200 '#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:10.0,
segment0.ts
#EXT-X-ENDLIST';
        }
        
        # ============================================
        # PLAYBACK CONTROL ENDPOINTS
        # ============================================
        
        # Play media
        location = /player/playback/playMedia {
            return 200 '{"status":"ok"}';
        }
        
        # Pause playback
        location = /player/playback/pause {
            return 200 '{"status":"ok"}';
        }
        
        # Resume playback
        location = /player/playback/play {
            return 200 '{"status":"ok"}';
        }
        
        # Stop playback
        location = /player/playback/stop {
            return 200 '{"status":"ok"}';
        }
        
        # Seek to position
        location = /player/playback/seekTo {
            return 200 '{"status":"ok"}';
        }
        
        # ============================================
        # TIMELINE & PROGRESS ENDPOINTS
        # ============================================
        
        # Update timeline
        location = /:/timeline {
            return 200 '{"status":"ok"}';
        }
        
        # Update progress
        location = /:/progress {
            return 200 '{"status":"ok"}';
        }
        
        # ============================================
        # ACTIVITIES & BACKGROUND TASKS
        # ============================================
        
        # Get activities
        location = /activities {
            add_header Content-Type application/json;
            return 200 '{"MediaContainer":{"size":0,"Activity":[]}}';
        }
        
        # ============================================
        # RESOURCES & STATIC CONTENT
        # ============================================
        
        # Resource images
        location ~ ^/:/resources/(.+)\.(png|jpg)$ {
            add_header Content-Type image/png;
            return 200 '';
        }
        
        # ============================================
        # CATCH-ALL
        # ============================================
        
        # Default response for unmatched endpoints
        location / {
            add_header Content-Type application/json;
            return 200 '{"status":"ok","message":"Mock Plex API endpoint","path":"$uri"}';
        }
    }
}
